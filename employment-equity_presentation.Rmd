---
title: "Employment Equity: An Analysis of Distribution of Salary Ranges of Public Service of Canada Employees"
author: "Brittny Vongdara & Catalina Albury"
date: "9/26/2022"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'index.html')) })
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# The Data

Here, disproportionality index is used as a measure of equitable representation. It is calculated as below.  
$$\frac{\%_{Group\: X; \:salary\: range \: i}}{\% _{All \:Employees; \:salary\: range \: i}} = DI _{Group\:X; \:salary\:range\:i}$$

For example, 23.51% of Black employees and 16.70% of all employees are are within the <60K salary range. This gives us a DI of 1.41. 

$$ DI_{Black \: employees; <60K } =\frac{23.51\%}{16.70\%} = 1.41$$

Below are the values used to create the figures. This data is based on self identification of equity-deserving groups, and represents pre-tax salary ranges excluding bonuses and promotions, [publically availble here](https://www.canada.ca/en/treasury-board-secretariat/services/innovation/human-resources-statistics/diversity-inclusion-statistics.html). It was collected in March of 2021. Please note that this data was not imputed for suppressed numbers. For more information and the scripts used to produce this analysis, visit the project's [GitHub repository](https://github.com/klaxonklaxoff/ee_dv).



```{r , warning = FALSE, echo =  FALSE, message = FALSE}
# Load libraries ----
library(rvest)
library(dplyr)
library(tidyr)
library(plotly)
library(flextable)
library(stringr)
library(MetBrewer)

# Function ----
remove_commas <- function(comma_cols) {
  as.numeric(gsub(
    pattern = ",",
    replacement = "",
    x = comma_cols
  ))
}

# Refer to TBS website for web scraping
url <-
  "https://www.canada.ca/en/treasury-board-secretariat/services/innovation/human-resources-statistics/diversity-inclusion-statistics/distribution-public-service-canada-employees-designated-sub-group-salary-range-"

# Gather and manipulate data ----
df <-
  merge(x = {
    ## Visible Minority and Black employees ----
    {
      html_nodes(read_html(paste0(url,
                                  "members-visible-minorities")), "table") %>%
        html_table(fill = TRUE)
    }[[1]][-c(1, 19), c(1:4, 25)] %>% # retrieve all employees and total vm column
      rename(
        salary_range = "Salary range ($)",
        count_all = "All employees",
        count_black = "Black",
        count_vm = "Members of visible minorities"
      )
  },
  y = {
    ## Indigenous ----
    {
      html_nodes(read_html(paste0(url,
                                  "indigenous-peoples")), "table") %>%
        html_table(fill = TRUE)
    }[[1]][-c(1, 19), c(1, 11)] %>% # retrieve total indigenous column
      rename(salary_range = "Salary range ($)",
             count_indigenous = "Indigenous Peoples")
  },
  by = "salary_range",
  all = TRUE) %>%
  merge(y = {
    ## Persons with disabilities ----
    {
      html_nodes(read_html(paste0(url,
                                  "persons-disabilities")), "table") %>%
        html_table(fill = TRUE)
    }[[1]][-c(1, 19), c(1, 15)] %>% # retrieve total pwd column
      rename(salary_range = "Salary range ($)",
             count_pwd = "Persons with disabilities")
  },
  by = "salary_range",
  all = TRUE) %>% 
  mutate(across(everything(), ~ replace(., . ==  "Table 1 Footnote *" , NA))) %>% # replace foonote with NA
  mutate_at(vars(matches("count")), remove_commas) %>% # remove commas
  mutate(
    salary_range = sub(
      pattern = "    ",
      replacement = " ",
      x = salary_range
    ), # remove extra spaces in salary range column
    range_group = case_when(
      salary_range %in% c(
        "Under 25,000",
        "25,000 to 49,999",
        "50,000 to 54,999",
        "55,000 to 59,999"
      ) ~ "Less than $60,000",
      salary_range %in% c("60,000 to 64,999", "65,000 to 69,999") ~ "$60,000 to $69,999",
      salary_range %in% c("70,000 to 74,999", "75,000 to 79,999", "80,000 to 84,999") ~ "$70,000 to $84,999",
      salary_range %in% c("85,000 to 89,999",
                          "90,000 to 94,999",
                          "95,000 to 99,999") ~ "$85,000 to $99,999",
      salary_range %in% c(
        "100,000 to 149,999",
        "150,000 to 199,999",
        "200,000 to 249,999",
        "250,000 and over"
      ) ~ "Over $100,000K",
      TRUE ~ "All ranges"
    )
  ) %>% # group salary ranges to match Dr. Martin's numbers
  group_by(range_group) %>%
  summarize(
    count_all = sum(count_all, na.rm = TRUE),
    count_black = sum(count_black, na.rm = TRUE),
    count_vm = sum(count_vm, na.rm = TRUE),
    count_non_vm = count_all - count_vm,
    count_indigenous = sum(count_indigenous, na.rm = TRUE),
    count_pwd = sum(count_pwd, na.rm = TRUE)) %>% 
  ungroup() # summarize values in predetermined salary range groups

#'NOTE [needed to reorder the rows before this chunk of code]
df <- 
  df[c(5, 1, 2, 3, 6, 4), ] %>% 
  mutate(
    # create new column for percentage of representation within subgroup
    per_all = round(count_all / count_all[n()] * 100, 2),
    per_black = round(count_black / count_black[n()] * 100, 2),
    per_vm = round(count_vm / count_vm[n()] * 100, 2),
    per_non_vm = round(count_non_vm / count_non_vm[n()] * 100, 2),
    per_indigenous = round(count_indigenous / count_indigenous[n()] * 100, 2),
    per_pwd = round(count_pwd / count_pwd[n()] * 100, 2),
    
    # create new column for disproportionality index (DI)
    di_all = 1,
    di_black = round(per_black / per_all, 2),
    di_vm = round(per_vm / per_all, 2),
    di_non_vm = round(per_non_vm / per_all, 2),
    di_indigenous = round(per_indigenous / per_all, 2),
    di_pwd = round(per_pwd / per_all, 2),
    
    # create new column to highlight difference from 1 for DI
    chart_black = di_black - 1,
    chart_vm = di_vm - 1,
    chart_non_vm = di_non_vm - 1,
    chart_indigenous = di_indigenous - 1,
    chart_pwd = di_pwd - 1,
  ) %>%
  select(
    range_group,
    per_all,
    di_all,
    
    per_black,
    di_black,
    chart_black,
    
    per_vm,
    di_vm,
    chart_vm,
    
    per_non_vm,
    di_non_vm,
    chart_non_vm,
    
    per_indigenous,
    di_indigenous,
    chart_indigenous,
    
    per_pwd,
    di_pwd,
    chart_pwd
  ) 

# Create table to show raw data 
# Remove chart columns amd convert to flextable object
export_table <- flextable(select(df, -contains("chart")))

# Change header labels
export_table <- set_header_labels(export_table,
  values = list(
    range_group = "Salary Range",
    per_all = "Percent",
    di_all = "DI",
    per_black = "Percent",
    di_black = "DI",
    per_vm = "Percent",
    di_vm = "DI",
    per_non_vm = "Percent",
    di_non_vm = "DI",
    per_indigenous = "Percent",
    di_indigenous = "DI",
    per_pwd = "Percent",
    di_pwd = "DI"
  )
)

export_table <-  add_header_row(export_table,
                     colwidths = c(1, 2,2,2,2,2,2),
                     values = c(" ", "All Employees", "Black Employees", "All Visible Minority Employees", "Non-Visible Minority Employees", "Indigenous Employees", "Employees with Disabilities"))

theme_zebra(export_table)



df <- df %>% 
  pivot_longer(cols = matches(c("per", "di", "chart")),
               names_to = "temp",
               values_to = "value") %>% # reshape data so it's easier to deal with
  mutate(
    # separate into unit of measure
    uom = case_when(grepl(pattern = "^per", x = as.character(temp)) ~ "Percent", 
                    grepl(pattern = "^di", x = as.character(temp)) ~ "DI",
                    grepl(pattern = "^chart", x = as.character(temp)) ~ "Chart"),
    # separate into subgroups
    subgroup = case_when(
      grepl(pattern = "all$", x = temp) ~ "All",
      grepl(pattern = "black$", x = temp) ~ "Black",
      grepl(pattern = "non_vm$", x = temp) ~ "Non Visible Minorities",
      grepl(pattern = "_vm$", x = temp) ~ "Visible Minorities",
      grepl(pattern = "indigenous$", x = temp) ~ "Indigenous",
      grepl(pattern = "pwd$", x = temp) ~ "Persons with disabilities"
    ),
    # add colours for easier consumption in charts
    chart_colour = case_when((uom == "Chart" & value > 0) ~ "red",
                             (uom == "Chart" & value < 0) ~ "green",
                             TRUE ~ NA_character_
    )
  ) %>% # FIXME: I feel like this section could be done better?
  select("Salary range" = range_group, Value = value, "Unit of measure" = uom, Subgroup = subgroup, chart_colour)



# Remove "all ranges" entries
df <- df %>% filter(`Salary range` != "All ranges")

# Neater salary categories
df$`Salary range` <- factor(df$`Salary range`, 
                            levels = c("Less than $60,000", "$60,000 to $69,999", "$70,000 to $84,999", "$85,000 to $99,999",  "Over $100,000K" ), 
                            labels = c("<60.0K", "60.0-69.9K", "70.0-84.9K", "85.0-99.9K", "100.0K+"))

# Remove "all" category entries
df <- df %>% filter(Subgroup != "All")

# Better group descriptions
df$Subgroup <- factor(df$Subgroup,
                      levels = c("Non Visible Minorities","Visible Minorities",  "Persons with disabilities", "Indigenous", "Black"), 
                      labels = c("Non-Visible Minority Employees", "Visible Minority Employees",  "Employees with Disabilities", "Indigenous Employees", "Black Employees"))

```






# Plot 1: DI of all groups by salary range {.tabset}

The dotted line represents equitable representation. It can been seen that Black employees are overrepresented at the lower salary ranges and underrepresented at higher ranges compared to the other groups. As can be seen by the "All Non-Minority Employees" bars, an equal DI across all salary ranges should be expected. 


## English
```{r Plot 1 English, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 7.5}

library(MetBrewer)

# Select only DI data 
salarydataplot1 <-  df %>% filter(`Unit of measure` == "DI")

# Make a vector with corresponding colors
colors = met.brewer("Johnson", 5)

# Bar plot showing salary ranges by group 
ggplot(salarydataplot1, aes(fill = Subgroup, 
                            y = Value,
                            x = `Salary range`)) + 
  geom_bar(position = 'dodge', 
           stat ='identity') +
  theme_classic() +
  xlab("Salary range") +
  ylab("Disproportionality Index") +
  geom_hline(yintercept = 1, 
             linetype = "dashed") +
  scale_fill_manual(
    values = colors) +
  coord_cartesian(ylim = c(.5, 1.5)) +
  theme(legend.position = "top",
        legend.title=element_blank(),
       text = element_text(size = 15),
       legend.text = element_text(size = 12)) +
  guides(fill = guide_legend(nrow=2, byrow=TRUE)) +
  annotate("text", 
           y = 1.02, 
            x= "100.0K+",
            hjust = .25, 
            label = "Overrepresented") +
  annotate("text", 
           y = 0.98, 
            x= "100.0K+",
            hjust = .25, 
            label = "Underrepresented")


```


## Français
```{r Plot 1 French, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 7.5}
# Select only DI data 
salarydataplot1_fr <-  df %>% filter(`Unit of measure` == "DI")

# Make a vector with corresponding colors
colors = met.brewer("Johnson", 5)


#French labels
salarydataplot1_fr$Subgroup <- factor(salarydataplot1_fr$Subgroup,
                      levels = c("Non-Visible Minority Employees", "Visible Minority Employees",  "Employees with Disabilities", "Indigenous Employees", "Black Employees"),
                      labels = c("Employés qui ne sont pas une\nmembre de minorités visibles", "Employés membres\n de minorités visibles",  "Employés en\nsituation de handicap", "Employés autochtones", "Employés Noirs"))

# Change salary categories to have commas instead of periods
salarydataplot1_fr$`Salary range` <- factor(salarydataplot1_fr$`Salary range`,
                            levels = c("<60.0K", "60.0-69.9K", "70.0-84.9K", "85.0-99.9K", "100.0K+"),
                            labels = c("<60,0K", "60,0-69,9K", "70,0-84,9K", "85,0-99,9K", "100,0K+"))
 
# Change periods to commas
options(OutDec= ",")

# Bar plot showing salary ranges by group 
ggplot(salarydataplot1_fr, aes(fill = Subgroup, 
                            y = Value,
                            x = `Salary range`)) + 
  geom_bar(position = 'dodge', 
           stat ='identity') +
  theme_classic() +
  xlab("Échelle salariale") +
  ylab("Indice de disproportionnalité") +
  geom_hline(yintercept = 1, 
             linetype = "dashed") +
  scale_fill_manual(
    values = colors) +
  coord_cartesian(ylim = c(.5, 1.5)) +
  theme(legend.position = "top",
        legend.title=element_blank(),
       text = element_text(size = 15),
       legend.text = element_text(size = 12)) +
  guides(fill = guide_legend(nrow=2, byrow=TRUE)) +
  annotate("text", 
           y = 1.02, 
            x= "100,0K+",
            hjust = .25, 
            label = "Surreprésenté") +
  annotate("text", 
           y = 0.98, 
            x= "100,0K+",
            hjust = .25, 
            label = "Sous-représentés")
```



# Plot 2: DI *Share* by subgroups and salary range{.tabset}

Here, DI is subtracted from 1 to calculate a DI Share metric, meaning that 0 rather than 1 would represent equitable representation. Each column is coloured based on if the DI Share is negative or positive.  


## English
```{r Plot 2 English, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 7.5}
# Color pallette

library(MetBrewer)

colors <- met.brewer("Hiroshige", 5)[c(1,4)]

# Edit chart color labels 
df$chart_colour <- factor(df$chart_colour, 
                          levels = c("red", "green", NA), 
                          labels = c("Overrepresented", "Underrepresented"))

# Change periods to commas
options(OutDec= ".")

ggplotly({
  ggplot(df[df$`Unit of measure` == "Chart" &
              df$`Salary range` != "All ranges", ]) +
    geom_bar(
      stat = "identity",
      position = "dodge",
      aes(
        x = factor(
          x = `Salary range`
        ),
        y = Value,
        fill = chart_colour,
        text = paste0(
          "Subgroup: ", Subgroup,
          "<br>",
          "Salary range: ", `Salary range`,
          "<br>",
          "Disproportionality Index share: ", round(Value, 2)
        )
      )
    ) +
    theme_minimal() +
        scale_fill_manual(labels = c("Underrepresented", "Overrepresented"), 
                      values = colors,
                      name = "") +
    theme(legend.position="bottom",
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(colour = "black"),        
      text = element_text(size = 12),
      legend.text = element_text(size = 12)) +
    labs(title = NULL,
         x = "Salary range",
         y = "Disproportionality Index share") +
    facet_wrap(facets = ~ factor(
      x = Subgroup
    ),
    ncol = 1)
}, tooltip = "text")

```
 
 

## Français

```{r Plot 2 French, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 7.5}
# Color pallette

library(MetBrewer)

plot2_fr <- df 

colors <- met.brewer("Hiroshige", 5)[c(1,4)]

# Edit chart color labels 
plot2_fr$chart_colour <- factor(plot2_fr$chart_colour, 
                          levels = c("Overrepresented", "Underrepresented"), 
                          labels = c("Surreprésenté", "Sous-représenté" ))

#French labels
plot2_fr$Subgroup <- factor(plot2_fr$Subgroup,
                      levels = c("Non-Visible Minority Employees", "Visible Minority Employees",  "Employees with Disabilities", "Indigenous Employees", "Black Employees"),
                      labels = c("Employés qui ne sont pas une\nmembre de minorités visibles", "Employés membres\n de minorités visibles",  "Employés en\nsituation de handicap", "Employés autochtones", "Employés Noirs"))

# Change salary categories to have commas instead of periods
plot2_fr$`Salary range` <- factor(plot2_fr$`Salary range`,
                            levels = c("<60.0K", "60.0-69.9K", "70.0-84.9K", "85.0-99.9K", "100.0K+"),
                            labels = c("<60,0K", "60,0-69,9K", "70,0-84,9K", "85,0-99,9K", "100,0K+"))
 
# Change periods to commas
options(OutDec= ",")

ggplotly({
  ggplot(plot2_fr[plot2_fr$`Unit of measure` == "Chart" &
              plot2_fr$`Salary range` != "All ranges", ]) +
    geom_bar(
      stat = "identity",
      position = "dodge",
      aes(
        x = factor(
          x = `Salary range`
        ),
        y = Value,
        fill = chart_colour,
        text = paste0(
          "Sous-groupe : ", Subgroup,
          "<br>",
          "Échelle salariale : ", `Salary range`,
          "<br>",
          "Indice de disproportionnalité partage : ", round(Value, 2)
        )
      )
    ) +
    theme_minimal() +
        scale_fill_manual(labels = c("Sous-représentés", "Surreprésenté"), 
                      values = colors,
                      name = "") +
    theme(legend.position="bottom",
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.background = element_blank(),
      axis.line = element_line(colour = "black"),        
      text = element_text(size = 12),
      legend.text = element_text(size = 12)) +
    labs(title = NULL,
         x = "Échelle salariale",
         y = "Indice de disproportionnalité partage") +
    facet_wrap(facets = ~ factor(
      x = Subgroup
    ),
    ncol = 1)
}, tooltip = "text")

```

# Plot 3: A direct comparison of DI in Black Employees vs. Non-Visible Minority Employees{.tabset}

This plot zooms in on our "baseline" group and compares it to the Black employee group, which appears to be the most affected by inequity. A steady decrease in representation with each increase in salary range is clearly visible for the Black employee group. 


## English
```{r Plot 3 eng, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 7.5}
 
colors <- met.brewer("Johnson", 5)[c(1,5)]

# Change periods to commas
options(OutDec= ".")

ggplot(df[df$`Unit of measure` == "DI" &
            df$Subgroup %in% c("Non-Visible Minority Employees", "Black Employees"),]) +
  geom_bar(stat = "identity",
           position = "dodge",
           aes(x = Subgroup,
               y = Value,
               fill = Subgroup, 
               alpha = `Salary range`)) +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"), 
    text = element_text(size = 15),
    legend.text = element_text(size = 12)
  ) +
  scale_fill_manual  (values = colors, 
                      ) +
  labs(title = NULL,
       x = NULL,
       y = "Disproportionality Index",
       fill = NULL) + 
  guides(fill="none")

 
```

## Français
```{r Plot 3 fr, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 7.5}
 
colors <- met.brewer("Johnson", 5)[c(1,5)]

plot3_fr <- df

#French labels
plot3_fr$Subgroup <- factor(plot3_fr$Subgroup,
                      levels = c("Non-Visible Minority Employees", "Visible Minority Employees",  "Employees with Disabilities", "Indigenous Employees", "Black Employees"),
                      labels = c("Employés qui ne sont pas une\nmembre de minorités visibles", "Employés membres\n de minorités visibles",  "Employés en\nsituation de handicap", "Employés autochtones", "Employés Noirs"))

# Change salary categories to have commas instead of periods
plot3_fr$`Salary range` <- factor(plot3_fr$`Salary range`,
                            levels = c("<60.0K", "60.0-69.9K", "70.0-84.9K", "85.0-99.9K", "100.0K+"),
                            labels = c("<60,0K", "60,0-69,9K", "70,0-84,9K", "85,0-99,9K", "100,0K+"))
 
# Change periods to commas
options(OutDec= ",")

ggplot(plot3_fr[plot3_fr$`Unit of measure` == "DI" &
            plot3_fr$Subgroup %in% c("Employés qui ne sont pas une\nmembre de minorités visibles", "Employés Noirs"),]) +
  geom_bar(stat = "identity",
           position = "dodge",
           aes(x = Subgroup,
               y = Value,
               fill = Subgroup, 
               alpha = `Salary range`)) +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black"), 
    text = element_text(size = 15),
    legend.text = element_text(size = 12)
  ) +
  scale_fill_manual  (values = colors, 
                      ) +
  labs(title = NULL,
       x = NULL,
       y = "Indice de disproportionnalité",
       fill = NULL) + 
  guides(fill = "none", 
         alpha = guide_legend(title = "Échelle salariale"))
  
  

 
```